// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  // url moved to prisma.config.ts (Prisma 7 requirement)
}

model Site {
  id          String   @id @default(cuid())
  title       String
  description String?
  url         String
  imageUrl    String?
  author      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Many-to-many relationship with tags
  tags   SiteTag[]
  images Image[]

  @@index([createdAt(sort: Desc)]) // Index for createdAt DESC sorting (critical for performance)
  @@index([createdAt(sort: Desc), id(sort: Asc)]) // Composite index for exact orderBy clause
  @@map("sites")
}

model Tag {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())

  // Many-to-many relationship with sites
  sites   SiteTag[]
  // Aliases for fuzzy matching
  aliases TagAlias[]

  @@map("tags")
}

model TagAlias {
  id    String @id @default(cuid())
  alias String @unique
  tagId String
  tag   Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@map("tag_aliases")
}

model SiteTag {
  id     String @id @default(cuid())
  siteId String
  tagId  String

  site Site @relation(fields: [siteId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([siteId, tagId])
  @@map("site_tags")
}

// -----------------------------
// Unified Asset Model (formerly Image)
// -----------------------------
// This is a unified table for all searchable assets (websites, packaging, apps, etc.)
// All assets share the same embedding space and tagging system.
// To add a new category, simply use category = 'new-category' when creating assets.

model Image {
  id        String   @id @default(cuid())
  siteId    String? // Optional: for website images linked to sites
  sourceUrl String? // Optional: for packaging/other assets without a site (e.g., direct image URL)
  category  String   @default("website") // "website", "packaging", "app", "fonts", "graphic-design", "branding", etc. (flexible string, not enum)
  url       String // The actual image/asset URL
  width     Int?
  height    Int?
  bytes     Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  site      Site?    @relation(fields: [siteId], references: [id], onDelete: Cascade)

  // Relations for tagging system
  embedding ImageEmbedding? // One-to-one: CLIP embedding for this asset (same model/dimensionality for all categories)
  tags      ImageTag[] // Many-to-many: concept tags applied to this asset

  // Hub detection stats (computed by detect_hub_images.ts)
  hubCount                     Int? // Number of queries where image appears in top N
  hubScore                     Float? // Fraction of queries where image appears (hubCount / totalQueries)
  hubAvgCosineSimilarity       Float? // Average cosine similarity across all queries where image appears
  hubAvgCosineSimilarityMargin Float? // Average margin above query average (how much higher than average)

  // Relations for interaction tracking
  interactions UserInteraction[]
  
  // Relations for saved images
  savedBy SavedImage[]
  // Relations for collections
  inCollections CollectionImage[]

  @@unique([siteId, url], name: "siteId_url")
  @@index([category]) // Index for fast filtering by category
  @@index([siteId]) // Index for fast filtering by siteId
  @@index([siteId, category]) // Composite index for category + siteId queries
  @@map("images")
}

// Unified CLIP embedding table for all asset categories
// Same model, same dimensionality for websites, packaging, apps, etc.
// All assets go through the same embedding + tagging + reranker pipeline.
model ImageEmbedding {
  id          String   @id @default(cuid())
  imageId     String   @unique // FK to Image (the unified asset)
  model       String // CLIP model identifier (e.g., "openai/clip-vit-base-patch32")
  vector      Json // Store as normalized float array (same dimensionality for all categories)
  contentHash String?  @unique // SHA-256 of canonical PNG (nullable for migration)
  createdAt   DateTime @default(now())
  image       Image    @relation(fields: [imageId], references: [id], onDelete: Cascade)

  @@index([contentHash])
  @@index([imageId]) // Already unique, but explicit index helps with joins
  @@map("image_embeddings")
}

model Concept {
  id        String  @id
  label     String
  locale    String? @default("en")
  synonyms  Json // stored as array in JSON
  related   Json // stored as array in JSON
  opposites Json? // stored as array in JSON (opposite/excluding concept IDs)
  weight    Float?  @default(1.0)
  embedding Json

  // Backref
  images ImageTag[]
}

model ImageTag {
  imageId   String
  conceptId String
  score     Float
  image     Image   @relation(fields: [imageId], references: [id], onDelete: Cascade)
  concept   Concept @relation(fields: [conceptId], references: [id], onDelete: Cascade)

  @@id([imageId, conceptId])
  @@map("image_tags")
}

model QueryExpansion {
  term       String
  expansion  String
  source     String // 'groq' | 'curated' (previously 'gemini')
  category   String   @default("global") // Category ('global' for website/default, 'packaging', etc.) for category-specific expansions
  model      String? // 'llama-3.3-70b-versatile', etc.
  embedding  Json? // Cached CLIP embedding (stored as normalized float array) - prevents re-embedding on every request
  createdAt  DateTime @default(now())
  lastUsedAt DateTime @default(now())

  @@id([term, expansion, source, category])
  @@index([term, source, category])
  @@map("query_expansions")
}

// User interaction tracking for learned reranker
model UserInteraction {
  id             String   @id @default(cuid())
  query          String // Original query text
  queryEmbedding Json? // CLIP query embedding (stored as array)
  imageId        String
  position       Int // Rank position when shown (1-based)
  clicked        Boolean  @default(false)
  saved          Boolean  @default(false)
  dwellTime      Int? // Milliseconds spent viewing result
  timestamp      DateTime @default(now())

  // Features at time of query (for training)
  baseScore   Float? // CLIP cosine similarity
  tagFeatures Json? // Handcrafted tag features (matches, scores, etc.)

  image Image @relation(fields: [imageId], references: [id], onDelete: Cascade)

  @@index([query, imageId])
  @@index([timestamp])
  @@index([query, clicked])
  @@map("user_interactions")
}

enum AccountType {
  Pro
  Agency
  Enterprise
  VIP
}

// User authentication and accounts
model User {
  id          String      @id @default(cuid())
  username    String      @unique
  email       String?     @unique
  password    String // Hashed password
  accountType AccountType @default(Pro)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // User's saved images
  savedImages SavedImage[]
  // User's collections
  collections Collection[]

  @@map("users")
}

// User's saved images (bookmarks/collections)
model SavedImage {
  id        String   @id @default(cuid())
  userId    String
  imageId   String
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  image Image @relation(fields: [imageId], references: [id], onDelete: Cascade)

  @@unique([userId, imageId], name: "userId_imageId") // Prevent duplicate saves
  @@index([userId])
  @@index([imageId])
  @@map("saved_images")
}

// User's collections
model Collection {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user   User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  images CollectionImage[]

  @@unique([userId, name], name: "userId_name") // Prevent duplicate collection names per user
  @@index([userId])
  @@map("collections")
}

// Many-to-many relationship between collections and images
model CollectionImage {
  id           String   @id @default(cuid())
  collectionId String
  imageId      String
  createdAt    DateTime @default(now())

  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  image      Image      @relation(fields: [imageId], references: [id], onDelete: Cascade)

  @@unique([collectionId, imageId], name: "collectionId_imageId") // Prevent duplicate images in collection
  @@index([collectionId])
  @@index([imageId])
  @@map("collection_images")
}
